rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function emailLower() {
      return request.auth.token.email != null ? request.auth.token.email.toLowerCase() : null;
    }

    function isGroupHost(groupId) {
      return signedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.hostUid == request.auth.uid;
    }

    function isGroupMemberOrHost(groupId) {
      let g = get(/databases/$(database)/documents/groups/$(groupId)).data;
      return signedIn() && (
        g.hostUid == request.auth.uid ||
        (emailLower() != null && g.memberEmails.hasAny([emailLower()]))
      );
    }

    match /users/{uid} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow create, update: if signedIn() && request.auth.uid == uid;
    }

    match /groups/{groupId} {
      allow read: if signedIn() && (
        resource.data.hostUid == request.auth.uid ||
        (emailLower() != null && resource.data.memberEmails.hasAny([emailLower()]))
      );
      allow create: if signedIn() && request.resource.data.hostUid == request.auth.uid;
      allow update, delete: if signedIn() && resource.data.hostUid == request.auth.uid;
    }

    match /invitations/{inviteId} {
      allow read: if signedIn() && (
        resource.data.hostUid == request.auth.uid ||
        (emailLower() != null && resource.data.emailLower == emailLower())
      );
      allow create: if signedIn() && request.resource.data.hostUid == request.auth.uid;
      allow update: if signedIn() && (
        resource.data.hostUid == request.auth.uid ||
        (
          emailLower() != null &&
          resource.data.emailLower == emailLower() &&
          request.resource.data.redeemedByUid == request.auth.uid
        )
      );
      allow delete: if signedIn() && resource.data.hostUid == request.auth.uid;
    }

    match /responses/{responseId} {
      allow read: if signedIn() && isGroupMemberOrHost(resource.data.groupId);
      allow create: if signedIn() &&
        isGroupMemberOrHost(request.resource.data.groupId) &&
        request.resource.data.respondentUid == request.auth.uid;
      allow update, delete: if signedIn() && isGroupHost(resource.data.groupId);
    }
  }
}

